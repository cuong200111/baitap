<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üñºÔ∏è OG:Image Fixed Logic Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .test-section {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        background: #f9f9f9;
      }
      .test-section h3 {
        margin-top: 0;
        color: #333;
      }
      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .test-card {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        background: white;
      }
      .test-card h4 {
        margin-top: 0;
        color: #444;
      }
      .image-preview {
        width: 100%;
        height: 150px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 10px 0;
        font-size: 12px;
        color: #666;
        overflow: hidden;
      }
      .image-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
        border-radius: 4px;
      }
      .url-display {
        background: #f8f8f8;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        word-break: break-all;
        margin: 5px 0;
      }
      .status {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: bold;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.loading {
        background: #cce7ff;
        color: #004085;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      .test-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .test-btn:hover {
        background: #0056b3;
      }
      .logic-description {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        margin: 15px 0;
      }
    </style>
  </head>
  <body>
    <h1>üñºÔ∏è OG:Image Fixed Logic Test</h1>

    <div class="test-section">
      <h3>üìã Fixed Logic Description</h3>
      <div class="logic-description">
        <h4>‚ú® NEW LOGIC:</h4>
        <ul>
          <li>
            <strong>üõçÔ∏è Product pages:</strong> Use product's main image (product.image) or first image from gallery (product.images[0])
          </li>
          <li>
            <strong>üè∑Ô∏è Category pages:</strong> Use category image first, if not available ‚Üí use first product image from that category
          </li>
          <li>
            <strong>üîÑ Fallback:</strong> Only use SEO settings if no real images found
          </li>
          <li>
            <strong>üåê Backend:</strong> All images served from <code>http://localhost:4000/uploads/</code>
          </li>
        </ul>
      </div>
    </div>

    <div class="test-section">
      <h3>üß™ Test Product Pages</h3>
      <div class="test-grid" id="productTests">
        <!-- Will be populated by JavaScript -->
      </div>
      <button class="test-btn" onclick="testProductPages()">üîÑ Test Product OG:Images</button>
    </div>

    <div class="test-section">
      <h3>üè∑Ô∏è Test Category Pages</h3>
      <div class="test-grid" id="categoryTests">
        <!-- Will be populated by JavaScript -->
      </div>
      <button class="test-btn" onclick="testCategoryPages()">üîÑ Test Category OG:Images</button>
    </div>

    <div class="test-section">
      <h3>üìä Social Media Test Links</h3>
      <div id="socialTests">
        <!-- Will be populated by JavaScript -->
      </div>
      <button class="test-btn" onclick="generateSocialTestLinks()">üîó Generate Social Test Links</button>
    </div>

    <script>
      const testPages = {
        products: [
          { id: 7, name: "Gaming Product", expectedSource: "product.image" },
          { id: 1, name: "Laptop Gaming", expectedSource: "product.image" },
          { id: 2, name: "PC Desktop", expectedSource: "product.image or fallback" }
        ],
        categories: [
          { slug: "dien-thoai", name: "ƒêi·ªán tho·∫°i", expectedSource: "category.image or first product.image" },
          { slug: "laptop", name: "Laptop", expectedSource: "category.image or first product.image" },
          { slug: "gaming", name: "Gaming", expectedSource: "category.image or first product.image" }
        ]
      };

      function createTestCard(item, type, pageUrl) {
        return `
          <div class="test-card">
            <h4>${item.name}</h4>
            <div class="status loading" id="status-${type}-${item.id || item.slug}">Testing...</div>
            <div class="image-preview" id="preview-${type}-${item.id || item.slug}">
              Loading...
            </div>
            <div class="url-display">
              <strong>Page:</strong> ${pageUrl}
            </div>
            <div class="url-display" id="og-url-${type}-${item.id || item.slug}">
              <strong>OG:Image:</strong> <em>Loading...</em>
            </div>
            <div class="url-display">
              <strong>Expected:</strong> ${item.expectedSource}
            </div>
          </div>
        `;
      }

      async function extractOgImage(pageUrl) {
        try {
          // Using a CORS proxy for local testing
          const proxyUrl = `http://localhost:3000${pageUrl.replace('http://localhost:3000', '')}`;
          const response = await fetch(proxyUrl);
          const html = await response.text();

          // Extract og:image from HTML
          const ogImageMatch = html.match(/<meta\s+property=["']og:image["']\s+content=["']([^"']+)["']/i);
          const ogImage = ogImageMatch ? ogImageMatch[1] : null;

          return {
            success: true,
            ogImage,
            isBackendImage: ogImage && ogImage.includes('/uploads/'),
            isReal: ogImage && !ogImage.includes('placeholder') && !ogImage.includes('default')
          };
        } catch (error) {
          console.error(`Error extracting og:image from ${pageUrl}:`, error);
          return {
            success: false,
            error: error.message
          };
        }
      }

      async function testSinglePage(item, type) {
        const pageUrl = type === 'product' 
          ? `http://localhost:3000/products/${item.id}`
          : `http://localhost:3000/category/${item.slug}`;

        const statusEl = document.getElementById(`status-${type}-${item.id || item.slug}`);
        const previewEl = document.getElementById(`preview-${type}-${item.id || item.slug}`);
        const ogUrlEl = document.getElementById(`og-url-${type}-${item.id || item.slug}`);

        statusEl.textContent = 'Testing...';
        statusEl.className = 'status loading';

        const result = await extractOgImage(pageUrl);

        if (result.success && result.ogImage) {
          statusEl.textContent = result.isBackendImage && result.isReal ? 'Success ‚úÖ' : 'Using Fallback ‚ö†Ô∏è';
          statusEl.className = result.isBackendImage && result.isReal ? 'status success' : 'status warning';
          
          previewEl.innerHTML = `<img src="${result.ogImage}" alt="${item.name}" onerror="this.parentElement.innerHTML='‚ùå Image failed to load'">`;
          ogUrlEl.innerHTML = `<strong>OG:Image:</strong> ${result.ogImage}`;

          console.log(`‚úÖ ${type} ${item.id || item.slug}:`, {
            ogImage: result.ogImage,
            isBackendImage: result.isBackendImage,
            isReal: result.isReal
          });
        } else {
          statusEl.textContent = 'Error ‚ùå';
          statusEl.className = 'status error';
          previewEl.innerHTML = '‚ùå No og:image found';
          ogUrlEl.innerHTML = `<strong>Error:</strong> ${result.error || 'No og:image found'}`;
        }
      }

      async function testProductPages() {
        const container = document.getElementById('productTests');
        container.innerHTML = testPages.products.map(product => 
          createTestCard(product, 'product', `http://localhost:3000/products/${product.id}`)
        ).join('');

        console.log('üß™ Testing Product Pages...');
        
        // Test each product page
        for (const product of testPages.products) {
          await testSinglePage(product, 'product');
        }
      }

      async function testCategoryPages() {
        const container = document.getElementById('categoryTests');
        container.innerHTML = testPages.categories.map(category => 
          createTestCard(category, 'category', `http://localhost:3000/category/${category.slug}`)
        ).join('');

        console.log('üß™ Testing Category Pages...');
        
        // Test each category page
        for (const category of testPages.categories) {
          await testSinglePage(category, 'category');
        }
      }

      function generateSocialTestLinks() {
        const container = document.getElementById('socialTests');
        const testUrls = [
          'http://localhost:3000/products/7',
          'http://localhost:3000/category/dien-thoai'
        ];

        const socialPlatforms = {
          facebook: (url) => `https://developers.facebook.com/tools/debug/?q=${encodeURIComponent(url)}`,
          twitter: () => `https://cards-dev.twitter.com/validator`,
          linkedin: () => `https://www.linkedin.com/post-inspector/`,
          opengraph: (url) => `https://www.opengraph.xyz/?url=${encodeURIComponent(url)}`
        };

        let html = '<h4>Test your pages on social platforms:</h4>';
        
        testUrls.forEach(url => {
          html += `<div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">`;
          html += `<strong>${url}</strong><br>`;
          Object.entries(socialPlatforms).forEach(([platform, generator]) => {
            const testUrl = generator(url);
            html += `<a href="${testUrl}" target="_blank" style="margin-right: 10px; color: #007bff;">${platform}</a>`;
          });
          html += `</div>`;
        });

        container.innerHTML = html;
      }

      // Auto-run tests on page load
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üîç OG:Image Fixed Logic Test Suite Loaded');
        
        // Auto-test after a delay
        setTimeout(() => {
          testProductPages();
          setTimeout(() => {
            testCategoryPages();
          }, 2000);
        }, 1000);
      });
    </script>
  </body>
</html>
