<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîç Advanced Error Detector</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f8fafc;
        line-height: 1.6;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .tool-header {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .error-category {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 16px 0;
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
      }
      .error-category h3 {
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .error-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f9fafb;
      }
      .error-item {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        font-family: monospace;
        font-size: 13px;
      }
      .error-item:last-child {
        border-bottom: none;
      }
      .error-severe {
        background: #fef2f2;
        border-left: 4px solid #ef4444;
      }
      .error-warning {
        background: #fffbeb;
        border-left: 4px solid #f59e0b;
      }
      .error-info {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
      }
      .btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        margin: 4px;
        transition: all 0.2s;
      }
      .btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }
      .btn-danger {
        background: #dc2626;
      }
      .btn-danger:hover {
        background: #b91c1c;
      }
      .btn-warning {
        background: #d97706;
      }
      .btn-warning:hover {
        background: #b45309;
      }
      .url-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin: 8px 0;
        font-size: 14px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin: 20px 0;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #cbd5e1;
      }
      .stat-card.severe {
        border-left-color: #ef4444;
      }
      .stat-card.warning {
        border-left-color: #f59e0b;
      }
      .stat-card.info {
        border-left-color: #3b82f6;
      }
      .stat-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .console-output {
        background: #1f2937;
        color: #f9fafb;
        padding: 16px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        margin: 12px 0;
      }
      .test-progress {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin: 16px 0;
      }
      .test-progress-fill {
        background: linear-gradient(90deg, #3b82f6, #06b6d4);
        height: 100%;
        transition: width 0.3s ease;
      }
      .iframe-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
      }
      .iframe-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        height: 90%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      .iframe-header {
        background: #374151;
        color: white;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .iframe-close {
        background: #ef4444;
        border: none;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
      }
      .page-test-iframe {
        width: 100%;
        height: calc(100% - 50px);
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="tool-header">
        <h1>üîç Advanced Error Detector</h1>
        <p>Tool ph√°t hi·ªán l·ªói chuy√™n s√¢u: JavaScript errors, Console errors, Network failures, Performance issues</p>
        
        <input type="text" id="testUrl" class="url-input" 
               value="https://20bdfb1e64e3483694c7ba59225ae1a6-ffe7619288fb40b59e347ff8b.fly.dev" 
               placeholder="URL base ƒë·ªÉ test">
        
        <div style="margin: 16px 0;">
          <button class="btn" onclick="startDeepScan()">üöÄ B·∫Øt ƒë·∫ßu qu√©t s√¢u</button>
          <button class="btn btn-warning" onclick="testCurrentPage()">üîç Test trang hi·ªán t·∫°i</button>
          <button class="btn" onclick="testRandomPages()">üé≤ Test ng·∫´u nhi√™n</button>
          <button class="btn btn-danger" onclick="clearAllErrors()">üóëÔ∏è X√≥a k·∫øt qu·∫£</button>
        </div>

        <div class="test-progress" id="testProgress" style="display: none;">
          <div class="test-progress-fill" id="testProgressFill"></div>
        </div>
      </div>

      <div class="stats-grid" id="errorStats" style="display: none;">
        <div class="stat-card severe">
          <div class="stat-number" id="severeCount">0</div>
          <div>L·ªói Nghi√™m Tr·ªçng</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-number" id="warningCount">0</div>
          <div>C·∫£nh B√°o</div>
        </div>
        <div class="stat-card info">
          <div class="stat-number" id="infoCount">0</div>
          <div>Th√¥ng Tin</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pagesScanned">0</div>
          <div>Trang ƒê√£ Qu√©t</div>
        </div>
      </div>

      <div class="error-category">
        <h3>üö® JavaScript Errors</h3>
        <div class="error-list" id="jsErrors">
          <div class="error-item">Ch∆∞a ph√°t hi·ªán l·ªói n√†o...</div>
        </div>
      </div>

      <div class="error-category">
        <h3>‚ö†Ô∏è Console Warnings</h3>
        <div class="error-list" id="consoleWarnings">
          <div class="error-item">Ch∆∞a ph√°t hi·ªán c·∫£nh b√°o n√†o...</div>
        </div>
      </div>

      <div class="error-category">
        <h3>üåê Network Issues</h3>
        <div class="error-list" id="networkErrors">
          <div class="error-item">Ch∆∞a ph√°t hi·ªán v·∫•n ƒë·ªÅ m·∫°ng n√†o...</div>
        </div>
      </div>

      <div class="error-category">
        <h3>üñºÔ∏è Missing Resources</h3>
        <div class="error-list" id="missingResources">
          <div class="error-item">Ch∆∞a ph√°t hi·ªán t√†i nguy√™n thi·∫øu n√†o...</div>
        </div>
      </div>

      <div class="error-category">
        <h3>üìä Performance Issues</h3>
        <div class="error-list" id="performanceIssues">
          <div class="error-item">Ch∆∞a ph√°t hi·ªán v·∫•n ƒë·ªÅ hi·ªáu su·∫•t n√†o...</div>
        </div>
      </div>

      <div class="error-category">
        <h3>üñ•Ô∏è Console Output</h3>
        <div class="console-output" id="consoleOutput">
          ƒêang ch·ªù b·∫Øt ƒë·∫ßu qu√©t...
        </div>
      </div>
    </div>

    <!-- Hidden iframe for testing -->
    <div class="iframe-container" id="iframeContainer">
      <div class="iframe-content">
        <div class="iframe-header">
          <span id="iframeTitle">Testing Page...</span>
          <button class="iframe-close" onclick="closeIframe()">‚úï</button>
        </div>
        <iframe id="testIframe" class="page-test-iframe"></iframe>
      </div>
    </div>

    <script>
      let errorStats = {
        severe: 0,
        warning: 0,
        info: 0,
        pagesScanned: 0
      };

      let allErrors = [];
      let isScanning = false;

      const PAGES_TO_TEST = [
        '/',
        '/products',
        '/products/1', 
        '/products/7',
        '/category/laptop',
        '/category/dien-thoai',
        '/cart',
        '/checkout',
        '/login',
        '/register',
        '/profile',
        '/orders',
        '/admin',
        '/admin/products',
        '/admin/categories',
        '/admin/orders',
        '/admin/users',
        '/admin/settings'
      ];

      function logToConsole(message, type = 'info') {
        const console = document.getElementById('consoleOutput');
        const timestamp = new Date().toLocaleTimeString();
        const color = type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#22c55e';
        
        console.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
        console.scrollTop = console.scrollHeight;
      }

      function addError(category, message, severity = 'info', url = '') {
        const container = document.getElementById(category);
        const errorItem = document.createElement('div');
        errorItem.className = `error-item error-${severity}`;
        
        const timestamp = new Date().toLocaleTimeString();
        errorItem.innerHTML = `
          <strong>[${timestamp}]</strong> ${message}
          ${url ? `<br><small>URL: ${url}</small>` : ''}
        `;
        
        container.appendChild(errorItem);
        container.scrollTop = container.scrollHeight;
        
        // Update stats
        errorStats[severity]++;
        updateErrorStats();
        
        // Log to console
        logToConsole(`${severity.toUpperCase()}: ${message}`, severity);
        
        // Store error
        allErrors.push({
          category,
          message,
          severity,
          url,
          timestamp: new Date()
        });
      }

      function updateErrorStats() {
        document.getElementById('severeCount').textContent = errorStats.severe;
        document.getElementById('warningCount').textContent = errorStats.warning;
        document.getElementById('infoCount').textContent = errorStats.info;
        document.getElementById('pagesScanned').textContent = errorStats.pagesScanned;
        document.getElementById('errorStats').style.display = 'grid';
      }

      function updateProgress(current, total) {
        const progress = document.getElementById('testProgress');
        const fill = document.getElementById('testProgressFill');
        
        progress.style.display = 'block';
        fill.style.width = (current / total * 100) + '%';
        
        if (current >= total) {
          setTimeout(() => {
            progress.style.display = 'none';
          }, 2000);
        }
      }

      async function testPageForErrors(url, pageName) {
        return new Promise((resolve) => {
          logToConsole(`ƒêang test: ${pageName} (${url})`);
          
          // Create hidden iframe for testing
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = url;
          
          let errorsCaught = 0;
          let warningsCaught = 0;
          
          // Set timeout for page load
          const timeout = setTimeout(() => {
            addError('networkErrors', `Timeout loading ${pageName}`, 'warning', url);
            document.body.removeChild(iframe);
            resolve({ errors: errorsCaught, warnings: warningsCaught });
          }, 15000);
          
          iframe.onload = () => {
            clearTimeout(timeout);
            
            try {
              // Try to access iframe content and inject error monitoring
              const iframeWindow = iframe.contentWindow;
              const iframeDoc = iframe.contentDocument;
              
              if (iframeWindow && iframeDoc) {
                // Inject error monitoring script
                const script = iframeDoc.createElement('script');
                script.textContent = `
                  // Monitor JavaScript errors
                  window.addEventListener('error', function(e) {
                    window.parent.postMessage({
                      type: 'jsError',
                      message: e.message,
                      filename: e.filename,
                      lineno: e.lineno,
                      colno: e.colno,
                      url: window.location.href
                    }, '*');
                  });
                  
                  // Monitor unhandled promise rejections
                  window.addEventListener('unhandledrejection', function(e) {
                    window.parent.postMessage({
                      type: 'promiseRejection',
                      message: e.reason,
                      url: window.location.href
                    }, '*');
                  });
                  
                  // Monitor console errors
                  const originalConsoleError = console.error;
                  console.error = function(...args) {
                    window.parent.postMessage({
                      type: 'consoleError',
                      message: args.join(' '),
                      url: window.location.href
                    }, '*');
                    originalConsoleError.apply(console, args);
                  };
                  
                  // Monitor console warnings
                  const originalConsoleWarn = console.warn;
                  console.warn = function(...args) {
                    window.parent.postMessage({
                      type: 'consoleWarn',
                      message: args.join(' '),
                      url: window.location.href
                    }, '*');
                    originalConsoleWarn.apply(console, args);
                  };
                  
                  // Check for missing images
                  setTimeout(() => {
                    const images = document.querySelectorAll('img');
                    images.forEach(img => {
                      if (!img.complete || img.naturalHeight === 0) {
                        window.parent.postMessage({
                          type: 'missingImage',
                          src: img.src,
                          url: window.location.href
                        }, '*');
                      }
                    });
                  }, 3000);
                `;
                
                iframeDoc.head.appendChild(script);
                
                // Check page title for error indicators
                const title = iframeDoc.title.toLowerCase();
                if (title.includes('error') || title.includes('404') || title.includes('500')) {
                  addError('networkErrors', `Error page detected: ${iframeDoc.title}`, 'severe', url);
                  errorsCaught++;
                }
                
                // Check for error messages in page content
                const bodyText = iframeDoc.body?.textContent?.toLowerCase() || '';
                if (bodyText.includes('error') && bodyText.includes('occurred')) {
                  addError('jsErrors', `Error message found in page content`, 'warning', url);
                  warningsCaught++;
                }
                
              }
              
              // Wait for errors to be caught
              setTimeout(() => {
                document.body.removeChild(iframe);
                resolve({ errors: errorsCaught, warnings: warningsCaught });
              }, 5000);
              
            } catch (e) {
              // Cross-origin restriction - this is expected for external URLs
              addError('networkErrors', `Cross-origin restriction (normal for external URLs)`, 'info', url);
              document.body.removeChild(iframe);
              resolve({ errors: errorsCaught, warnings: warningsCaught });
            }
          };
          
          iframe.onerror = () => {
            clearTimeout(timeout);
            addError('networkErrors', `Failed to load ${pageName}`, 'severe', url);
            document.body.removeChild(iframe);
            resolve({ errors: 1, warnings: 0 });
          };
          
          document.body.appendChild(iframe);
        });
      }

      // Listen for messages from iframes
      window.addEventListener('message', function(event) {
        const data = event.data;
        
        switch (data.type) {
          case 'jsError':
            addError('jsErrors', `${data.message} (${data.filename}:${data.lineno}:${data.colno})`, 'severe', data.url);
            break;
          case 'promiseRejection':
            addError('jsErrors', `Unhandled Promise Rejection: ${data.message}`, 'severe', data.url);
            break;
          case 'consoleError':
            addError('consoleWarnings', `Console Error: ${data.message}`, 'warning', data.url);
            break;
          case 'consoleWarn':
            addError('consoleWarnings', `Console Warning: ${data.message}`, 'info', data.url);
            break;
          case 'missingImage':
            addError('missingResources', `Missing Image: ${data.src}`, 'warning', data.url);
            break;
        }
      });

      async function startDeepScan() {
        if (isScanning) {
          logToConsole('Scan ƒëang ch·∫°y...', 'warning');
          return;
        }
        
        isScanning = true;
        clearAllErrors();
        
        const baseUrl = document.getElementById('testUrl').value;
        logToConsole('B·∫Øt ƒë·∫ßu qu√©t s√¢u t·∫•t c·∫£ c√°c trang...', 'info');
        
        for (let i = 0; i < PAGES_TO_TEST.length; i++) {
          const page = PAGES_TO_TEST[i];
          const fullUrl = baseUrl + page;
          const pageName = page === '/' ? 'Homepage' : page;
          
          updateProgress(i, PAGES_TO_TEST.length);
          
          await testPageForErrors(fullUrl, pageName);
          errorStats.pagesScanned++;
          updateErrorStats();
          
          // Small delay between tests
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        updateProgress(PAGES_TO_TEST.length, PAGES_TO_TEST.length);
        logToConsole(`Ho√†n th√†nh qu√©t ${PAGES_TO_TEST.length} trang!`, 'info');
        logToConsole(`T√¨m th·∫•y ${errorStats.severe} l·ªói nghi√™m tr·ªçng, ${errorStats.warning} c·∫£nh b√°o`, 'info');
        
        isScanning = false;
      }

      async function testCurrentPage() {
        const currentUrl = window.location.href;
        logToConsole('Testing current page...', 'info');
        await testPageForErrors(currentUrl, 'Current Page');
        errorStats.pagesScanned++;
        updateErrorStats();
      }

      async function testRandomPages() {
        const baseUrl = document.getElementById('testUrl').value;
        const randomPages = PAGES_TO_TEST.sort(() => 0.5 - Math.random()).slice(0, 5);
        
        logToConsole('Testing 5 random pages...', 'info');
        
        for (let i = 0; i < randomPages.length; i++) {
          const page = randomPages[i];
          const fullUrl = baseUrl + page;
          const pageName = page === '/' ? 'Homepage' : page;
          
          await testPageForErrors(fullUrl, pageName);
          errorStats.pagesScanned++;
          updateErrorStats();
        }
        
        logToConsole('Completed testing random pages!', 'info');
      }

      function clearAllErrors() {
        const categories = ['jsErrors', 'consoleWarnings', 'networkErrors', 'missingResources', 'performanceIssues'];
        
        categories.forEach(category => {
          const container = document.getElementById(category);
          container.innerHTML = '<div class="error-item">Ch∆∞a ph√°t hi·ªán l·ªói n√†o...</div>';
        });
        
        document.getElementById('consoleOutput').innerHTML = 'Console cleared...';
        
        errorStats = { severe: 0, warning: 0, info: 0, pagesScanned: 0 };
        allErrors = [];
        updateErrorStats();
        
        logToConsole('ƒê√£ x√≥a t·∫•t c·∫£ k·∫øt qu·∫£', 'info');
      }

      function closeIframe() {
        document.getElementById('iframeContainer').style.display = 'none';
      }

      // Auto-start basic scan on load
      window.addEventListener('DOMContentLoaded', function() {
        logToConsole('Advanced Error Detector loaded', 'info');
        logToConsole('Ready to scan for JavaScript errors, console warnings, network issues...', 'info');
      });
    </script>
  </body>
</html>
